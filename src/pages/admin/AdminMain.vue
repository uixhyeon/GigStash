<template>
  <div class="p-6 bg-slate-50 dark:bg-slate-900 h-[100vh - 64px] scrollbar-hide">
    <!-- <h1 class="text-3xl font-bold mb-8" style="color: #1e293b">Main Home</h1> -->

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="mb-12 grid grid-cols-1 lg:grid-cols-2 gap-8">
      <section>
        <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-table-header-text">
          ë‹¹ì¼ ë³´ê´€í•¨ í˜„í™©
        </h2>

        <div
          v-if="loading"
          class="p-6 text-center bg-white dark:bg-slate-800 rounded-2xl shadow-sm"
          style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
        >
          í†µê³„ ë¡œë”© ì¤‘...
        </div>
        <div v-else class="grid grid-cols-2 gap-3 mb-4">
          <!-- ë¯¸ì‚¬ìš© -->
          <div
            class="p-3 sm:p-4 md:p-5 rounded-2xl shadow-sm backdrop-blur-sm bg-white/80 dark:bg-slate-800/50 border border-blue-100 dark:border-blue-900/30"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0 flex-1">
                <div
                  class="text-[11px] sm:text-xs font-medium text-gray-600 dark:text-gray-400 truncate"
                >
                  ë¯¸ì‚¬ìš©
                </div>
                <div
                  class="text-xl sm:text-2xl md:text-3xl font-bold mt-1 text-blue-600 dark:text-blue-400"
                >
                  {{ stats.available }}
                </div>
                <div class="text-[9px] sm:text-xs text-gray-500 dark:text-gray-500 mt-0.5">
                  í˜„ì¬ ê°€ìš©
                </div>
              </div>
              <i class="fi fi-rr-box text-lg sm:text-xl flex-shrink-0" style="color: #3b82f6"></i>
            </div>
          </div>

          <!-- ì‚¬ìš©ì¤‘ -->
          <div
            class="p-3 sm:p-4 md:p-5 rounded-2xl shadow-sm backdrop-blur-sm bg-white/80 dark:bg-slate-800/50 border border-amber-100 dark:border-amber-900/30"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0 flex-1">
                <div
                  class="text-[11px] sm:text-xs font-medium text-gray-600 dark:text-gray-400 truncate"
                >
                  ì‚¬ìš©ì¤‘
                </div>
                <div
                  class="text-xl sm:text-2xl md:text-3xl font-bold mt-1 text-amber-600 dark:text-amber-400"
                >
                  {{ stats.inUse }}
                </div>
                <div class="text-[9px] sm:text-xs text-gray-500 dark:text-gray-500 mt-0.5">
                  í˜„ì¬ ì‚¬ìš© ì¤‘
                </div>
              </div>
              <i class="fi fi-rr-lock text-lg sm:text-xl flex-shrink-0" style="color: #d97706"></i>
            </div>
          </div>

          <!-- ì‚¬ìš©ë¥  -->
          <div
            class="p-3 sm:p-4 md:p-5 rounded-2xl shadow-sm backdrop-blur-sm bg-white/80 dark:bg-slate-800/50 border border-green-100 dark:border-green-900/30"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0 flex-1">
                <div
                  class="text-[11px] sm:text-xs font-medium text-gray-600 dark:text-gray-400 truncate"
                >
                  ì‚¬ìš©ë¥ 
                </div>
                <div
                  class="text-xl sm:text-2xl md:text-3xl font-bold mt-1 text-green-600 dark:text-green-400"
                >
                  {{ stats.usageRate }}%
                </div>
                <div class="text-[9px] sm:text-xs text-gray-500 dark:text-gray-500 mt-0.5">
                  ì˜¤ëŠ˜ì˜ ì‚¬ìš©ë¥ 
                </div>
              </div>
              <i
                class="fi fi-rr-chart-pie text-lg sm:text-xl flex-shrink-0"
                style="color: #16a34a"
              ></i>
            </div>
          </div>

          <!-- í™œì„± ì˜ˆì•½ -->
          <div
            class="p-3 sm:p-4 md:p-5 rounded-2xl shadow-sm backdrop-blur-sm bg-white/80 dark:bg-slate-800/50 border border-purple-100 dark:border-purple-900/30 col-span-2 sm:col-span-1"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0 flex-1">
                <div
                  class="text-[11px] sm:text-xs font-medium text-gray-600 dark:text-gray-400 truncate"
                >
                  í™œì„± ì˜ˆì•½
                </div>
                <div
                  class="text-xl sm:text-2xl md:text-3xl font-bold mt-1 text-purple-600 dark:text-purple-400"
                >
                  {{ stats.activeReservations }}
                </div>
                <div class="text-[9px] sm:text-xs text-gray-500 dark:text-gray-500 mt-0.5">
                  ì§„í–‰ ì¤‘ì¸ ì˜ˆì•½
                </div>
              </div>
              <i
                class="fi fi-rr-calendar-check text-lg sm:text-xl flex-shrink-0"
                style="color: #a855f7"
              ></i>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-table-header-text">
          ê³ ê° ì°¸ì—¬ë„
        </h2>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <!-- ì¼ì¼ í™œì„± ì‚¬ìš©ì -->
          <div
            class="p-3 sm:p-4 md:p-5 rounded-2xl shadow-sm backdrop-blur-sm bg-white/80 dark:bg-slate-800/50 border border-blue-100 dark:border-blue-900/30"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0 flex-1">
                <div
                  class="text-[11px] sm:text-xs font-medium text-gray-600 dark:text-gray-400 truncate"
                >
                  ì¼ì¼ í™œì„± ì‚¬ìš©ì
                </div>
                <div
                  class="text-xl sm:text-2xl md:text-3xl font-bold mt-1 text-blue-600 dark:text-blue-400"
                >
                  {{ dailyActiveUsers }}
                </div>
                <div class="text-[9px] sm:text-xs text-gray-500 dark:text-gray-500 mt-0.5">
                  ì–´ì œ ëŒ€ë¹„ <span class="text-blue-600 dark:text-blue-400 font-medium">+12%</span>
                </div>
              </div>
              <i class="fi fi-rr-users text-lg sm:text-xl flex-shrink-0" style="color: #3b82f6"></i>
            </div>
          </div>

          <!-- ì¬ë°©ë¬¸ìœ¨ -->
          <div
            class="p-3 sm:p-4 md:p-5 rounded-2xl shadow-sm backdrop-blur-sm bg-white/80 dark:bg-slate-800/50 border border-amber-100 dark:border-amber-900/30"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0 flex-1">
                <div
                  class="text-[11px] sm:text-xs font-medium text-gray-600 dark:text-gray-400 truncate"
                >
                  ì¬ë°©ë¬¸ìœ¨
                </div>
                <div
                  class="text-xl sm:text-2xl md:text-3xl font-bold mt-1 text-amber-600 dark:text-amber-400"
                >
                  {{ repeatVisitRate }}%
                </div>
                <div class="text-[9px] sm:text-xs text-gray-500 dark:text-gray-500 mt-0.5">
                  ì§€ë‚œë‹¬ ëŒ€ë¹„
                  <span class="text-amber-600 dark:text-amber-400 font-medium">+5.2%</span>
                </div>
              </div>
              <i
                class="fi fi-rr-rotate-clockwise text-lg sm:text-xl flex-shrink-0"
                style="color: #d97706"
              ></i>
            </div>
          </div>

          <!-- ì‹ ê·œ ê³ ê° ë¹„ìœ¨ -->
          <div
            class="p-3 sm:p-4 md:p-5 rounded-2xl shadow-sm backdrop-blur-sm bg-white/80 dark:bg-slate-800/50 border border-green-100 dark:border-green-900/30 col-span-2 sm:col-span-1"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0 flex-1">
                <div
                  class="text-[11px] sm:text-xs font-medium text-gray-600 dark:text-gray-400 truncate"
                >
                  ì‹ ê·œ ê³ ê°
                </div>
                <div
                  class="text-xl sm:text-2xl md:text-3xl font-bold mt-1 text-green-600 dark:text-green-400"
                >
                  {{ newCustomerCount }}
                </div>
                <div class="text-[9px] sm:text-xs text-gray-500 dark:text-gray-500 mt-0.5">
                  ì´ë²ˆë‹¬ ì‹ ê·œ ({{ newCustomerPercentage }}%)
                </div>
              </div>
              <i
                class="fi fi-rr-user-add text-lg sm:text-xl flex-shrink-0"
                style="color: #16a34a"
              ></i>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!--í†µê³„ ì¹´ë“œ ë =============================================================================================================== -->

    <!-- ì¢Œì¸¡: ìµœê·¼ ì˜ˆì•½ í…Œì´ë¸” + ì°¨íŠ¸ (2ì¹¼ëŸ¼) -->
    <div class="lg:col-span-2">
      <!-- í…Œì´ë¸”ê³¼ ì°¨íŠ¸ ê·¸ë¦¬ë“œ -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- ìµœê·¼ ì˜ˆì•½ í…Œì´ë¸” -->
        <section>
          <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-table-header-text">
            ìµœê·¼ ì˜ˆì•½
          </h2>
          <div
            v-if="loading"
            class="p-6 text-center bg-white dark:bg-slate-800 rounded-2xl shadow-sm text-slate-600 dark:text-slate-400"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            ì˜ˆì•½ ë¡œë”© ì¤‘...
          </div>
          <div v-if="!loading" class="max-w-full overflow-x-auto scrollbar-hide">
            <table
              class="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-sm overflow-hidden text-[10px] sm:text-xs min-w-max"
              style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
            >
              <thead class="sticky top-0 bg-table-header-bg dark:bg-table-header-bg-dark">
                <tr>
                  <th
                    class="px-1 sm:px-2 py-1 sm:py-2 text-center font-semibold text-[9px] sm:text-xs text-table-header-text dark:text-table-header-text-dark whitespace-nowrap"
                  >
                    ID
                  </th>
                  <th
                    class="px-1 sm:px-2 py-1 sm:py-2 text-center font-semibold text-[9px] sm:text-xs text-table-header-text dark:text-table-header-text-dark whitespace-nowrap"
                  >
                    ì´ë²¤íŠ¸ ID
                  </th>
                  <th
                    class="px-1 sm:px-2 py-1 sm:py-2 text-center font-semibold text-[9px] sm:text-xs text-table-header-text dark:text-table-header-text-dark whitespace-nowrap"
                  >
                    ë³´ê´€í•¨ ID
                  </th>
                  <th
                    class="px-1 sm:px-2 py-1 sm:py-2 text-center font-semibold text-[9px] sm:text-xs text-table-header-text dark:text-table-header-text-dark whitespace-nowrap"
                  >
                    ë³´ê´€í•¨ëª…
                  </th>
                  <th
                    class="px-1 sm:px-2 py-1 sm:py-2 text-center font-semibold text-[9px] sm:text-xs text-table-header-text dark:text-table-header-text-dark whitespace-nowrap"
                  >
                    ë³´ê´€ ì‹œì‘ì‹œê°„
                  </th>
                  <th
                    class="px-1 sm:px-2 py-1 sm:py-2 text-center font-semibold text-[9px] sm:text-xs text-table-header-text dark:text-table-header-text-dark whitespace-nowrap"
                  >
                    ê³ ê°ëª…
                  </th>
                  <!-- <th
                  class="px-2 py-2 text-center font-semibold text-table-header-text dark:text-table-header-text-dark whitespace-nowrap"
                >
                  ì ‘ê·¼ì½”ë“œ
                </th> -->
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="reservation in recentReservations.slice(0, 6)"
                  :key="reservation.id"
                  class="border-t border-slate-200 dark:border-slate-700 h-8 sm:h-10"
                >
                  <td
                    class="px-1 sm:px-2 py-0.5 sm:py-1 text-center text-[9px] sm:text-xs text-slate-900 dark:text-slate-100 whitespace-nowrap"
                  >
                    {{ reservation.id }}
                  </td>
                  <td
                    class="px-1 sm:px-2 py-0.5 sm:py-1 text-center text-[9px] sm:text-xs text-slate-900 dark:text-slate-100 whitespace-nowrap"
                  >
                    {{ reservation.eventId }}
                  </td>
                  <td
                    class="px-1 sm:px-2 py-0.5 sm:py-1 text-center text-[9px] sm:text-xs text-slate-900 dark:text-slate-100 whitespace-nowrap"
                  >
                    {{ reservation.lockerId }}
                  </td>
                  <td
                    class="px-1 sm:px-2 py-0.5 sm:py-1 text-center text-[9px] sm:text-xs text-slate-900 dark:text-slate-100 whitespace-nowrap"
                  >
                    {{ reservation.lockerNumber }}
                  </td>
                  <td
                    class="px-1 sm:px-2 py-0.5 sm:py-1 text-center text-[9px] sm:text-xs text-slate-900 dark:text-slate-100 whitespace-nowrap"
                  >
                    {{ formatDateTime(reservation.createdAt) }}
                  </td>
                  <td
                    class="px-1 sm:px-2 py-0.5 sm:py-1 text-center text-[9px] sm:text-xs text-slate-900 dark:text-slate-100 whitespace-nowrap"
                  >
                    {{ reservation.customerName }}
                  </td>
                  <!-- <td
                  class="px-2 py-1 text-center text-slate-900 dark:text-slate-100 whitespace-nowrap"
                >
                  {{ reservation.accessCode }}
                </td> -->
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <section>
          <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-table-header-text">
            ë³´ê´€í•¨ ìƒíƒœ ë¶„í¬
          </h2>

          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-6"
            style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)"
          >
            <div class="h-64">
              <Bar :data="chartData" :options="chartOptions" />
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</template>

<script setup>
import { onMounted, computed } from 'vue'
import { Bar } from 'vue-chartjs'
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend,
} from 'chart.js'
import { useDataStore } from '@/stores/dataStore'
import ComStatusChip from '@/components/common/ComStatusChip.vue'
import ComCard from '@/components/common/ComCard.vue'

// Chart.js ë“±ë¡
ChartJS.register(CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend)

// ì¤‘ì•™ ë°ì´í„° ìŠ¤í† ì–´ ì‚¬ìš©
const dataStore = useDataStore()

// ë©”ëª¨ì´ì œì´ì…˜: ìŠ¤í† ì–´ì˜ ìƒíƒœë¥¼ ì§ì ‘ ì‚¬ìš©
const reservations = computed(() => dataStore.reservations)
const customers = computed(() => dataStore.customers)
const loading = computed(() => dataStore.isLoading)

// Firebase Firestoreì—ì„œ ë¡œë“œëœ ì‚¬ë¬¼í•¨ ë°ì´í„° ì‚¬ìš©
const lockers = computed(() => {
  const data = dataStore.lockers
  console.log('ğŸ” AdminMain.vue: lockers computed ì‹¤í–‰', {
    length: data.length,
    data: data.slice(0, 2)
  })
  return data
})

// í†µê³„ ê³„ì‚°
const stats = computed(() => {
  const total = lockers.value.length
  const inUse = lockers.value.filter((l) => l.status === 'active').length
  const maintenance = lockers.value.filter((l) => l.status === 'maintenance').length
  const broken = lockers.value.filter((l) => l.status === 'broken').length
  const available = total - inUse - maintenance - broken
  const activeReservations = reservations.value.filter((r) => r.status === 'active').length
  const usageRate = total > 0 ? Math.round((inUse / total) * 100) : 0

  console.log('ğŸ“Š AdminMain.vue: stats ê³„ì‚°', {
    total,
    available,
    inUse,
    maintenance,
    broken,
    usageRate,
    activeReservations
  })

  return {
    available,
    inUse,
    usageRate,
    activeReservations,
    totalCustomers: customers.value.length,
  }
})

// ê³ ê° ë§µ (ë©”ëª¨ì´ì œì´ì…˜: ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•œ ìºì‹œ)
const customerMap = computed(() => {
  const map = new Map()
  customers.value.forEach((c) => map.set(c.id, c))
  return map
})

// ìµœê·¼ ì˜ˆì•½ ëª©ë¡ (ë©”ëª¨ì´ì œì´ì…˜)
const recentReservations = computed(() => {
  return [...reservations.value]
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
    .map((res) => {
      const customer = customerMap.value.get(res.customerId)
      return {
        ...res,
        customerName: customer?.name || 'ê³ ê°ì •ë³´ì—†ìŒ',
      }
    })
    .slice(0, 6)
})

// í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ê³ ê° ì •ë³´ (ë©”ëª¨ì´ì œì´ì…˜)
const activeCustomers = computed(() => {
  const activeRes = reservations.value.filter((r) => r.status === 'active')
  return activeRes.map((res) => {
    const customer = customerMap.value.get(res.customerId)
    return {
      ...customer,
      lockerNumber: res.lockerNumber,
    }
  })
})

// ë³´ê´€í•¨ ìƒíƒœ ì°¨íŠ¸ ë°ì´í„° (stats ë°ì´í„° ì¬ì‚¬ìš©)
const chartData = computed(() => {
  const maintenance = lockers.value.filter((l) => l.status === 'maintenance').length
  const broken = lockers.value.filter((l) => l.status === 'broken').length

  return {
    labels: ['ë¯¸ì‚¬ìš©', 'ì‚¬ìš©ì¤‘', 'ì •ë¹„ì¤‘', 'ê³ ì¥'],
    datasets: [
      {
        label: 'ë³´ê´€í•¨ ìˆ˜',
        data: [
          stats.value.available,
          stats.value.inUse,
          maintenance,
          broken,
        ],
        backgroundColor: ['#007aff', '#34c759', '#ff9500', '#ff3b30'],
        borderRadius: 8,
      },
    ],
  }
})

// ì°¨íŠ¸ ì˜µì…˜
const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      display: false,
    },
  },
  scales: {
    y: {
      beginAtZero: true,
      ticks: {
        stepSize: 1,
      },
    },
  },
}

// ê³ ê° ì°¸ì—¬ë„ ì§€í‘œ
const dailyActiveUsers = computed(() => {
  // í™œì„± ì˜ˆì•½ ê±´ìˆ˜ë¥¼ ì¼ì¼ í™œì„± ì‚¬ìš©ì ìˆ˜ë¡œ ê³„ì‚°
  const activeCount = reservations.value.filter((r) => r.status === 'active').length
  return Math.max(activeCount, 0)
})

// ì¬ë°©ë¬¸ìœ¨ (ë©”ëª¨ì´ì œì´ì…˜: ìŠ¤í† ì–´ì˜ ê³ ê°ë³„ ì˜ˆì•½ ìˆ˜ ì‚¬ìš©)
const repeatVisitRate = computed(() => {
  if (customers.value.length === 0) return 0
  const repeatCustomers = Array.from(dataStore.customerReservationCount.values()).filter(
    (count) => count >= 2,
  ).length
  const rate = customers.value.length > 0 ? (repeatCustomers / customers.value.length) * 100 : 0
  return Math.round(rate)
})

const newCustomerCount = computed(() => {
  // ìµœê·¼ 30ì¼ ë‚´ ê°€ì…í•œ ê³ ê° ìˆ˜
  const thirtyDaysAgo = new Date()
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)

  return customers.value.filter((customer) => {
    const createdDate = new Date(customer.createdAt || 0)
    return createdDate >= thirtyDaysAgo
  }).length
})

const newCustomerPercentage = computed(() => {
  if (customers.value.length === 0) return 0
  const rate = (newCustomerCount.value / customers.value.length) * 100
  return Math.round(rate)
})

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
const getReservationStatus = (status) => {
  const statusMap = {
    active: 'in-use',
    completed: 'available',
    cancelled: 'broken',
    expired: 'maintenance',
  }
  return statusMap[status] || status
}

const formatDateTime = (dateTimeStr) => {
  const date = new Date(dateTimeStr)
  return date.toLocaleString('ko-KR', {
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
  })
}

const getMembershipLabel = (level) => {
  const labels = {
    platinum: 'í”Œë˜í‹°ë„˜',
    gold: 'ê³¨ë“œ',
    silver: 'ì‹¤ë²„',
    bronze: 'ë¸Œë¡ ì¦ˆ',
  }
  return labels[level] || level
}

const getMembershipClass = (level) => {
  const classes = {
    platinum: 'bg-black text-white',
    gold: 'bg-yellow-400 text-black',
    silver: 'bg-gray-300 text-black',
    bronze: 'bg-orange-600 text-white',
  }
  return classes[level] || 'bg-gray-200 text-black'
}

// ìŠ¤í† ì–´ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë¯€ë¡œ ë³„ë„ì˜ ë¡œë“œê°€ í•„ìš” ì—†ìŒ
// App.vueì—ì„œ ì´ˆê¸°í™”í•  ë•Œ ì´ë¯¸ ë¡œë“œë¨
onMounted(() => {
  // í•„ìš”ì‹œ ì¶”ê°€ ì´ˆê¸°í™” ì‘ì—…
})
</script>
